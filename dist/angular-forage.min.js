angular.module("ngForage",[]).factory("$forage",["$q",function(e){var r={prefix:"_ng_",defaultExpireTimeout:36e5,errorHandler:function(e){return e},driver:[localforage.INDEXEDDB,localforage.WEBSQL,localforage.LOCALSTORAGE]},n={UNKNOWN:{code:"forage_unknown_exception",message:"数据缓存未知异常"},SET:{code:"forage_set_exception",message:"添加数据缓存失败"},GET:{code:"forage_get_exception",message:"获取数据缓存失败"},REMOVE:{code:"forage_remove_exception",message:"删除数据缓存失败"},CLEAR:{code:"forage_clear_exception",message:"清除数据缓存失败"},TIME_EXPIRE:{code:"forage_time_expire_exception",message:"数据缓存时间过期"}},o={},a=function(a,i){return e(function(e,c){localforage.getItem(r.prefix+a,function(f,u){if(f||!u)return c(r.errorHandler(n.GET)),!1;var l=Number(u.expire_at);!isNaN(l)&&l>i?(o[a]={expire_at:l,data:u.data},e(u.data)):t.remove(a).then(function(){c(r.errorHandler(n.TIME_EXPIRE))},function(){c(r.errorHandler(n.UNKNOWN))})})})},t={config:function(e){r=angular.extend(r,e),localforage.config({driver:r.driver})},get:function(i){var c=Date.now(),f=o[i];return f?f.expire_at>c?e.when(f.data):t.remove(i).then(function(){return e.reject(r.errorHandler(n.TIME_EXPIRE))},function(){return e.reject(r.errorHandler(n.UNKNOWN))}):a(i,c)},set:function(a,t,i){return e(function(e,c){if(!angular.isString(a)||!angular.isObject(t))return c(r.errorHandler(n.SET)),!1;var f=Date.now();i=angular.isNumber(i)&&i>0?i:f+r.defaultExpireTimeout,o[a]={expire_at:i,data:t},localforage.setItem(r.prefix+a,{expire_at:i,data:t},function(o){o?c(r.errorHandler(n.SET)):e(t)})})},remove:function(a){return e(function(e,t){o[a]=void 0,localforage.removeItem(r.prefix+a,function(o){return o?(t(r.errorHandler(n.REMOVE)),!1):void e()})})},clear:function(){return e(function(e,a){o={},localforage.clear(function(o){return o?(a(r.errorHandler(n.CLEAR)),!1):void e()})})}};return t}]);