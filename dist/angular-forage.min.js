angular.module("ngForage",[]).provider("$forage",function(){var r={defaultExpireTime:9999999999999,transformError:function(r){return r},driver:[localforage.INDEXEDDB,localforage.WEBSQL,localforage.LOCALSTORAGE]},e={UNKNOWN:{code:"forage_unknown_exception",message:"数据缓存未知异常"},SET:{code:"forage_set_exception",message:"添加数据缓存失败"},GET:{code:"forage_get_exception",message:"获取数据缓存失败"},REMOVE:{code:"forage_remove_exception",message:"删除数据缓存失败"},CLEAR:{code:"forage_clear_exception",message:"清除数据缓存失败"},LENGTH:{code:"forage_length_exception",message:"获取缓存条目数量失败"},KEY:{code:"forage_key_exception",message:"获取缓存标识失败"},KEYS:{code:"forage_keys_exception",message:"获取所有缓存标识失败"},ITERATE:{code:"forage_iterate_exception",message:"迭代所有缓存数据失败"},TIME_EXPIRE:{code:"forage_time_expire_exception",message:"数据缓存时间过期"}};this.config=function(e){r=angular.extend(r,e),localforage.config({driver:r.driver})},this.$get=["$q",function(o){var n={},t=function(t,i){return o(function(o,f){localforage.getItem(t,function(c,u){if(c||!u)return f(r.transformError(e.GET)),!1;var g=Number(u.expire_at);!isNaN(g)&&g>i?(n[t]={expire_at:g,data:u.data},o(u.data)):a.remove(t).then(function(){f(r.transformError(e.TIME_EXPIRE))},function(){f(r.transformError(e.UNKNOWN))})})})},a={get:function(i){var f=Date.now(),c=n[i];return c?c.expire_at>f?o.when(c.data):a.remove(i).then(function(){return o.reject(r.transformError(e.TIME_EXPIRE))},function(){return o.reject(r.transformError(e.UNKNOWN))}):t(i,f)},set:function(t,a,i){return o(function(o,f){return angular.isString(t)&&angular.isObject(a)?(i=angular.isNumber(i)&&i>0?i:r.defaultExpireTime,n[t]={expire_at:i,data:a},void localforage.setItem(t,{expire_at:i,data:a},function(n){n?f(r.transformError(e.SET)):o(a)})):(f(r.transformError(e.SET)),!1)})},remove:function(t){return o(function(o,a){n[t]=void 0,localforage.removeItem(t,function(n){return n?(a(r.transformError(e.REMOVE)),!1):void o()})})},clear:function(){return o(function(o,t){n={},localforage.clear(function(n){return n?(t(r.transformError(e.CLEAR)),!1):void o()})})},length:function(){return o(function(o,n){localforage.length(function(t,a){return t?(n(r.transformError(e.LENGTH)),!1):void o(a)})})},key:function(n){return o(function(o,t){localforage.key(n,function(n,a){return n?(t(r.transformError(e.KEY)),!1):void o(a)})})},keys:function(){return o(function(o,n){localforage.keys(function(t,a){return t?(n(r.transformError(e.KEYS)),!1):void o(a)})})},iterate:function(t){return o(function(o,a){localforage.iterate(function(r,e,o){t(r.data,e,o),n[e]=void 0},function(n){return n?(a(r.transformError(e.ITERATE)),!1):void o()})})}};return a}]});