angular.module("ngForage",[]).factory("$forage",["$q",function(r){var e={prefix:"_ng_",defaultExpireTime:9999999999999,transformError:function(r){return r},driver:[localforage.INDEXEDDB,localforage.WEBSQL,localforage.LOCALSTORAGE]},o={UNKNOWN:{code:"forage_unknown_exception",message:"数据缓存未知异常"},SET:{code:"forage_set_exception",message:"添加数据缓存失败"},GET:{code:"forage_get_exception",message:"获取数据缓存失败"},REMOVE:{code:"forage_remove_exception",message:"删除数据缓存失败"},CLEAR:{code:"forage_clear_exception",message:"清除数据缓存失败"},TIME_EXPIRE:{code:"forage_time_expire_exception",message:"数据缓存时间过期"}},n={},t=function(t,i){return r(function(r,f){localforage.getItem(e.prefix+t,function(c,u){if(c||!u)return f(e.transformError(o.GET)),!1;var E=Number(u.expire_at);!isNaN(E)&&E>i?(n[t]={expire_at:E,data:u.data},r(u.data)):a.remove(t).then(function(){f(e.transformError(o.TIME_EXPIRE))},function(){f(e.transformError(o.UNKNOWN))})})})},a={config:function(r){e=angular.extend(e,r),localforage.config({driver:e.driver})},get:function(i){var f=Date.now(),c=n[i];return c?c.expire_at>f?r.when(c.data):a.remove(i).then(function(){return r.reject(e.transformError(o.TIME_EXPIRE))},function(){return r.reject(e.transformError(o.UNKNOWN))}):t(i,f)},set:function(t,a,i){return r(function(r,f){return angular.isString(t)&&angular.isObject(a)?(i=angular.isNumber(i)&&i>0?i:e.defaultExpireTime,n[t]={expire_at:i,data:a},void localforage.setItem(e.prefix+t,{expire_at:i,data:a},function(n){n?f(e.transformError(o.SET)):r(a)})):(f(e.transformError(o.SET)),!1)})},remove:function(t){return r(function(r,a){n[t]=void 0,localforage.removeItem(e.prefix+t,function(n){return n?(a(e.transformError(o.REMOVE)),!1):void r()})})},clear:function(){return r(function(r,t){n={},localforage.clear(function(n){return n?(t(e.transformError(o.CLEAR)),!1):void r()})})}};return a}]);